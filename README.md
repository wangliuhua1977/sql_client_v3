# SQL Notebook (sql_client_v2)

面向 Windows 11 风格的多标签 SQL 笔记本，基于 Java 22 + Swing + RSyntaxTextArea，支持 PostgreSQL / Hive 编辑、自动保存、离线元数据联想与双向链接标记。

## 主要功能
- **多窗口 SQL/Markdown 笔记**：使用 `JDesktopPane + JInternalFrame` 子窗口模式，支持拖动、最大化、最小化、调整大小与双击重命名；窗口可平铺排列。
- **数据库内笔记管理**：所有笔记以 Markdown 文本存储在本地 SQLite `notes` 表中，通过“打开/管理笔记”从数据库选择，无需文件系统。
- **自动保存**：每个窗口独立后台线程定期写入数据库，状态栏显示最近保存时间。
- **智能联想**：仅在表/视图、字段、函数/存储过程位置弹出；支持 Ctrl+Space 开关、上下键与回车/双击选择；使用频次排序与高亮，记录使用次数。
- **别名与模糊匹配**：`FROM/JOIN` 别名可用于列联想，支持 `%` 分词模糊匹配与下划线连续输入不关闭联想框；在输入 `表别名.` 时自动拉取并缓存字段。
- **双向链接**：编辑器内可插入 `[[标记]]`，支持跳转与反向链接解析。
- **元数据缓存与差分更新**：通过 HTTPS 拉取对象/列信息，信任局域网证书，写入本地 SQLite（WAL + busy timeout），只插入新增、删除缺失并按需更新列。
- **对象浏览器**：从“视图”菜单弹出树形浏览器，可按关键字搜索表/视图，点击表名时按需拉取并展示字段，默认不展开全部字段。
- **线程模型**：网络抓取、元数据维护、自动保存使用独立线程池，保持 UI 流畅。

## 快速开始
1. 确保安装 JDK 22 与 Maven，并允许访问 Maven Central。
2. 执行 `mvn -DskipTests package` 生成可执行 fat JAR。
3. 运行 `java -jar target/sql_client-*-jar-with-dependencies.jar` 启动应用。

> 若容器/网络限制导致构建失败，可在联网环境下重新执行 Maven 下载依赖。

## 版本更新日志
- **v0.3.6**
  - 修复列抓取时的嵌套事务报错，改为单一事务并在异常时回滚，避免 `cannot start a transaction within a transaction`。
  - 仅在别名可解析或表已缓存时才触发表级列联想，防止对无效别名发起 HTTP 请求；`表别名.` 继续即时弹出列列表。
  - 对象浏览器与列联想仍按需拉取字段，但在本地缓存缺失时先显示“加载中”并在写入后刷新列表。
- **v0.3.5**
  - 内部窗口标题双击重命名时不再破坏标题栏布局或触发其他窗口最大化，保持原始大小与位置。
  - `表别名.` 输入立即弹出列联想，若本地无字段则后台按需抓取并插入缓存，即使对象尚未出现在缓存中也会尝试补全。
  - 列写入增加重试并预留锁，缓解 `database is locked` 报错。
- **v0.3.4**
  - 对象浏览器改为按需加载列：默认不展开字段，点击表/视图后再读取本地缓存并必要时远程拉取。
  - SQL 编辑器在输入 `表别名.` 时立即弹出列联想，并会后台抓取缺失的字段缓存后自动刷新列表。
  - 列抓取增加重试与更长 busy timeout，降低并发写入 SQLite 时的锁冲突报错。
- **v0.3.3**
  - 修复 `select a. from table a` 场景下列联想空白的问题，缺失字段时会后台拉取并自动刷新联想弹窗。
  - 解决内部窗口初始化时的潜在未赋值引用错误。
  - 新增“对象浏览器”菜单，树形查看已缓存的表/视图与字段并支持模糊搜索。
- **v0.3.2**
  - 选择表/视图后后台自动调用字段 API 并写入本地 SQLite，`别名.` 输入时可立即弹出对应字段联想。
  - 窗口标题双击后直接在标题栏内编辑名称，无需弹窗且不会改变窗口大小或位置。
- **v0.3.1**
  - 双击子窗口重命名后保持原有位置与大小，不影响其他窗口。
  - 联想列表在方向键导航时不再跳回第一项，保持当前位置；`表别名.` 触发列补全。
  - 继续支持 `%` 分词模糊匹配与使用次数高亮排序，列补全会根据别名解析到真实表名。
- **v0.3.0**
  - 笔记改为 SQLite 存储（Markdown 文本），通过“打开/管理笔记”在数据库内创建、打开与保存。
  - 编辑区域改用内部子窗口，支持拖拽、最大化/最小化、平铺、双击重命名，关闭对象树仅保留笔记窗口与状态栏。
  - 联想框上下键不再自动跳回首项，支持 `%` 模糊分词，选择后按上下文替换当前片段并记录使用次数排序。
- **v0.2.0**
  - 完成文件打开/保存/保存全部功能，支持选择数据库类型并更新标签标题。
  - 联想框仅在选择后关闭，支持上下键/回车/双击选择、别名列补全与下划线连续输入。
  - 补全时替换当前输入片段并记录使用次数排序，高亮已使用条目。
- **v0.1.x**
  - 初版 UI、元数据差分更新、自动保存、多线程和基础联想能力。

