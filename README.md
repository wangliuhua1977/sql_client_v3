# SQL Notebook (sql_client_v2)

面向 Windows 11 风格的多标签 SQL 笔记本，基于 Java 22 + Swing + RSyntaxTextArea，支持 PostgreSQL / Hive 编辑、自动保存、离线元数据联想与双向链接标记。

## 主要功能
- **多窗口/面板 SQL 笔记**：默认 `JDesktopPane + JInternalFrame` 子窗口，可切换到“视图-面板模式”使用顶部标签在单窗体内切换编辑器；子窗口支持拖动、最大化、最小化、调整大小与右键标题重命名，窗口可平铺排列。
- **数据库内笔记管理**：所有笔记以 Markdown 文本存储在本地 SQLite `notes` 表中，标题全局唯一；“导入笔记”用于将本地 *.sql/Markdown 写入数据库，“管理笔记”用于浏览与打开数据库内笔记。
- **笔记分组与检索**：管理面板展示创建时间/最后修改时间、标签与星标，单一检索框可切换全文检索模式并在下方预览匹配内容，可在表格内直接编辑标签/星标。
- **自动保存**：每个窗口独立后台线程定期写入数据库，状态栏显示最近保存时间。
- **SQL 执行与结果面板**：工具栏提供执行/停止按钮，按所选 SQL（分号分隔）异步调用 HTTPS 接口；子窗口在底部展示各条语句返回的数据表，面板模式统一在主界面底部展示所有结果。
- **智能联想**：仅在表/视图、字段、函数/存储过程位置弹出；始终开启（无开关），支持上下键与回车/双击选择；使用频次排序与高亮，记录使用次数。
- **别名与模糊匹配**：`FROM/JOIN` 别名可用于列联想，支持 `%` 分词模糊匹配与下划线连续输入不关闭联想框；在输入 `表别名.` 时自动拉取并缓存字段。
- **双向链接**：编辑器内可插入 `[[标记]]`，支持跳转与反向链接解析。
- **元数据缓存与差分更新**：通过 HTTPS 拉取对象/列信息，信任局域网证书，写入本地 SQLite（WAL + busy timeout），只插入新增、删除缺失并按需更新列。
- **对象浏览器**：从“视图”菜单弹出树形浏览器，可按关键字搜索表/视图，点击表名时按需拉取并展示字段，默认不展开全部字段。
- **线程模型**：网络抓取、元数据维护、自动保存使用独立线程池，保持 UI 流畅。
- **可配置输入修正与主题**：在“文件-设置”中可开启/关闭中文全角符号自动转半角（默认开启），管理/保存多套 SQL 编辑器主题（字体、背景/前景、关键字/字符串/注释颜色等），并可下次启动自动载入当前主题；按住 Shift + 鼠标滚轮可临时放大/缩小字体。

## 快速开始
1. 确保安装 JDK 22 与 Maven，并允许访问 Maven Central。
2. 执行 `mvn -DskipTests package` 生成可执行 fat JAR。
3. 运行 `java -jar target/sql_client-*-jar-with-dependencies.jar` 启动应用。

> 若容器/网络限制导致构建失败，可在联网环境下重新执行 Maven 下载依赖。

## 版本更新日志
- **v0.3.28**
  - 工具栏执行/停止按钮改为三角形/黑色方形图标，避免误触；Ctrl+Enter 在光标所在连续非空行区块执行 SQL。
  - 结果面板默认收起，可点击展开；同一窗口/面板中多条 SQL 返回结果以选项卡呈现，提示行数与 SQL hint，且支持在面板模式下统一折叠/展开。
  - 结果表格使用淡色背景、边框与网格美化，默认隐藏“sn_”列并保持行高、表头高亮。
- **v0.3.27**
  - 新增 SQL 执行功能：工具栏“执行/停止”作用于当前笔记窗口或面板，支持按所选语句（分号分隔）异步调用 HTTPS 接口，互不阻塞且可独立停止。
  - 结果展示：子窗口模式在每个子窗体下方依序显示返回数据表，面板模式在主界面底部统一展示各笔记的结果子面板，悬停标题可查看对应 SQL。
  - 返回结果按接口 `rows_count` 展示行数，自动过滤 `sn_` 列并在表格中呈现数据，执行状态在状态栏提示。
- **v0.3.26**
  - 字段联想遵循远端返回的 `sort_no` 顺序进行排序（不在 UI 展示），确保字段列表与表实际定义顺序一致，同时在排序尾部保留使用次数与名称的次级规则。
- **v0.3.25**
  - FROM/JOIN/WHERE 等关键字后的空格触发表联想后，继续输入时实时过滤匹配表名，避免只显示历史使用过的条目。
  - 仍保持仅限关键字/别名上下文触发联想，避免无关位置弹窗。
- **v0.3.24**
  - 修复联想上下文解析在极端光标位置可能触发的 `StringIndexOutOfBoundsException`，进一步收紧空白扫描边界，保证联想弹窗稳定。
  - 继续保持表/列/函数/存储过程联想默认开启、关键字后空格或别名点触发的行为。
- **v0.3.23**
  - 联想只在当前分号语句内、指定关键字后的第一个空格或 `别名.` 触发：`UPDATE/DELETE/TRUNCATE/DROP TABLE/EXISTS/FROM/JOIN/WHERE` 后弹出表/视图，`ON` 后或 `别名.` 后弹出字段，`SELECT` 后弹出函数，`CALL` 后弹出存储过程。
  - 去除了其他键位的自动触发，保持联想框仅由空格/点激活；空列表会按需刷新元数据并回填结果。
- **v0.3.22**
  - 重新收紧联想触发规则：仅在 `UPDATE/DELETE/TRUNCATE/DROP TABLE/EXISTS/FROM/JOIN/WHERE` 后首个空格弹出表/视图，在 `ON` 后首个空格或 `别名.` 后弹出字段，在 `SELECT` 后首个空格弹出函数，在 `CALL` 后首个空格弹出存储过程。
  - 表/列/函数/存储过程联想保持按使用次数排序与高亮，“加载中...” 期间自动刷新，避免空列表。
- **v0.3.21**
  - 修正 FROM/JOIN/WHERE/SELECT/CALL 等关键字后的联想解析，在正在输入表名或空格后即可弹出表/视图、函数或存储过程列表。
  - 列联想仅解析当前分号内的别名，不跨语句误用其他表；移除编辑器“自动联想”提示气泡，保持界面简洁。
- **v0.3.20**
  - 自动联想默认开启且不再提供 Ctrl+Space 开关，相关提示文案同步调整。
- **v0.3.19**
  - 管理笔记新增“移入垃圾箱/恢复/清空垃圾箱”，全文检索结果列表可预览命中位置，双击直接打开笔记，预览区默认显示完整正文。
  - SQL 编辑器主题增加全套语法高亮色（关键字/数据类型/函数/数字/运算符/标识符/字面量/字符串/注释/当前行/括号等），所有颜色可通过选择器自定义并保存多套方案。
  - 编辑器设置保留全角转半角开关；导入/新建/重命名笔记仍保证标题唯一。
- **v0.3.18**
  - “管理笔记”统一单一检索框并可切换全文检索，同时在下方预览匹配内容，支持高亮关键字。
  - 新建笔记先输入标题，子窗口标题改为右键重命名；Shift + 鼠标滚轮可临时调整字体大小。
  - SQL 编辑器设置支持保存/切换多套主题配置（颜色、字体等），下次启动默认载入当前主题。
- **v0.3.17**
  - 启动时全量扫描笔记标题，按顺序为重复项追加“(副本 n)”确保唯一，再创建唯一索引，彻底避免旧库重复标题导致初始化失败。
  - 去重操作使用事务与内存集合保证标题唯一性，不再依赖索引创建时的异常回退。
- **v0.3.16**
  - 启动时自动清理重复笔记标题并追加“(副本 n)”后缀，保证唯一索引创建不会失败，旧库可无感迁移。
- **v0.3.15**
  - SQLite 初始化增加列存在性检查，自动为旧版笔记表补齐 created_at/updated_at/tags/starred 列与唯一索引，避免因旧库缺列导致启动失败。
- **v0.3.14**
  - 笔记标题强制唯一，导入本地 *.sql/Markdown 文件时会提示选择数据库类型并直接写入 SQLite。
  - 新增“管理笔记”面板，支持创建时间/修改时间、标签、星标列排序，支持普通与全文检索（标题+正文），表格内可直接编辑标签和星标。
  - 笔记管理与打开入口分离：导入用于磁盘文件，管理用于数据库笔记浏览/排序/全文搜索与打开。

- **v0.3.13**
  - 修复中文全角标点未被自动转换的问题，增加按键级别的实时转换，确保常见引号/括号/逗号等输入后立即变为半角。
  - 别名解析限定在当前分号语句内，并在 `select a.` 等场景向后扫描 FROM/JOIN 段，保证多表别名总能弹出对应表的字段联想。
  - 主窗口内部引用改为显式提取编辑器实例，避免潜在“变量未初始化”编译告警并提升模式切换兼容性。

- **v0.3.12**
  - 子窗口的最小化/最大化/关闭按钮恢复与标准 Windows 行为一致，最大化按钮可在恢复时回到原始大小和位置。
  - 新增“面板模式”与“独立窗口模式”切换（视图菜单），面板模式以标签页承载所有编辑器，独立窗口模式使用子窗体，可随时切换且保留当前已打开的笔记。

- **v0.3.11**
  - 联想解析仅限当前分号内的语句，`FROM/JOIN/WHERE` 后空格立即弹出表/视图列表，`SELECT ` 弹出函数，`CALL ` 弹出存储过程并在确认时自动补 `()`。
  - 列联想在有别名时不再显示表名注释；当语句包含多个表且未指定别名时，字段列表会追加表名后缀并继续按使用次数排序。
  - 别名匹配进一步收紧，避免多表 JOIN 时错用其他表字段；字段获取优先读本地缓存，右键刷新或缺失时才远程更新。
- **v0.3.10**
  - 修正多表 JOIN 时别名解析偏移导致 `b.` 等别名错误匹配其他表字段的问题，保证列联想严格对应当前别名的真实表。
  - 子窗口重命名恢复为常见的输入对话框方式，不再修改标题栏布局，避免任何大小或位置的意外变化。
- **v0.3.9**
  - 改进 `currentToken` 与别名解析，确保多表 JOIN 场景下 `b.` 等别名准确返回对应表字段，不再混用其他表的列。
  - 新增会话恢复：退出时记录已打开的笔记 ID，启动时自动还原上次窗口集合，避免重启后被全部关闭。
  - 保存、重命名、新建窗口都会同步更新会话状态，防止手动退出前状态丢失。
- **v0.3.8**
  - `select ... 别名.` 与多表别名联合查询立即弹出列联想，即使 FROM/JOIN 出现在光标之后也能解析别名。
  - 联想列表展示并按使用次数降序排列，已使用条目加粗且显示引用计数。
  - 保持按需拉取字段的策略，优先使用本地缓存；必要时才后台拉取并更新缓存。
- **v0.3.7**
  - 列联想始终优先读取本地 SQLite 缓存，只有缺失或手动刷新时才发起 HTTPS 请求并写回缓存，避免重复拉取导致报错。
  - 对象浏览器新增右键菜单“刷新字段（远程）”，可在选中表名后强制更新字段缓存；SQL 编辑器联想也会在缓存为空时才触发远程抓取。
  - 列写入事务增加保存点与自动提交恢复，进一步规避 `cannot start a transaction within a transaction` 异常。
- **v0.3.6**
  - 修复列抓取时的嵌套事务报错，改为单一事务并在异常时回滚，避免 `cannot start a transaction within a transaction`。
  - 仅在别名可解析或表已缓存时才触发表级列联想，防止对无效别名发起 HTTP 请求；`表别名.` 继续即时弹出列列表。
  - 对象浏览器与列联想仍按需拉取字段，但在本地缓存缺失时先显示“加载中”并在写入后刷新列表。
- **v0.3.5**
  - 内部窗口标题双击重命名时不再破坏标题栏布局或触发其他窗口最大化，保持原始大小与位置。
  - `表别名.` 输入立即弹出列联想，若本地无字段则后台按需抓取并插入缓存，即使对象尚未出现在缓存中也会尝试补全。
  - 列写入增加重试并预留锁，缓解 `database is locked` 报错。
- **v0.3.4**
  - 对象浏览器改为按需加载列：默认不展开字段，点击表/视图后再读取本地缓存并必要时远程拉取。
  - SQL 编辑器在输入 `表别名.` 时立即弹出列联想，并会后台抓取缺失的字段缓存后自动刷新列表。
  - 列抓取增加重试与更长 busy timeout，降低并发写入 SQLite 时的锁冲突报错。
- **v0.3.3**
  - 修复 `select a. from table a` 场景下列联想空白的问题，缺失字段时会后台拉取并自动刷新联想弹窗。
  - 解决内部窗口初始化时的潜在未赋值引用错误。
  - 新增“对象浏览器”菜单，树形查看已缓存的表/视图与字段并支持模糊搜索。
- **v0.3.2**
  - 选择表/视图后后台自动调用字段 API 并写入本地 SQLite，`别名.` 输入时可立即弹出对应字段联想。
  - 窗口标题双击后直接在标题栏内编辑名称，无需弹窗且不会改变窗口大小或位置。
- **v0.3.1**
  - 双击子窗口重命名后保持原有位置与大小，不影响其他窗口。
  - 联想列表在方向键导航时不再跳回第一项，保持当前位置；`表别名.` 触发列补全。
  - 继续支持 `%` 分词模糊匹配与使用次数高亮排序，列补全会根据别名解析到真实表名。
- **v0.3.0**
  - 笔记改为 SQLite 存储（Markdown 文本），通过“打开/管理笔记”在数据库内创建、打开与保存。
  - 编辑区域改用内部子窗口，支持拖拽、最大化/最小化、平铺、双击重命名，关闭对象树仅保留笔记窗口与状态栏。
  - 联想框上下键不再自动跳回首项，支持 `%` 模糊分词，选择后按上下文替换当前片段并记录使用次数排序。
- **v0.2.0**
  - 完成文件打开/保存/保存全部功能，支持选择数据库类型并更新标签标题。
  - 联想框仅在选择后关闭，支持上下键/回车/双击选择、别名列补全与下划线连续输入。
  - 补全时替换当前输入片段并记录使用次数排序，高亮已使用条目。
- **v0.1.x**
  - 初版 UI、元数据差分更新、自动保存、多线程和基础联想能力。

